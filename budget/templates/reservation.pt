<!DOCTYPE html>
<html lang="${request.locale_name}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="pyramid web application">
    <meta name="author" content="Brett Lentz">
    <link rel="shortcut icon" href="${request.static_url('budget:static/pyramid-16x16.png')}">

    <title>OpenShift Statistics and Reporting</title>

    <link href="${request.static_url('budget:static/theme.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/reservation.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/jquery-ui-1.11.4/jquery-ui.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/DataTables-1.10.11/media/css/jquery.dataTables.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/DataTables-1.10.11/media/css/dataTables.jqueryui.css')}" rel="stylesheet">

    <script src="${request.static_url('budget:static/jquery-2.1.4.min.js')}"></script>
    <script src="${request.static_url('budget:static/DataTables-1.10.11/media/js/jquery.dataTables.js')}"></script>
		<script src="${request.static_url('budget:static/DataTables-1.10.11/media/js/dataTables.jqueryui.js')}"></script>
  </head>

  <body>

		<div id="note">
				<p>For each listing, the delta will be:</p>
				<ul>
						<li>positive if there are unused reservations</li>
						<li>negative if there are on-demand instances in need of reservation</li>
				</ul>
		</div>
		<div id="csv" class="link">
				<a href="/reservation/csv">Click for CSV</a>
		</div>
		<div class="results_container" tal:repeat="account results" tal:attributes="id account">
				<table class="results_table" id="${account}">
						<thead class="account_header">
								<tr>
										<th id="${account}" class="account_name_header" tal:content="account"> Account Name</th>
								</tr>
						</thead>
						<tbody>
								<tr class="results_row">
										<td class="results_col">
												<!-- sub-table -->
												<table class="datatable" id="${account}">
														<thead>
																<tr>
																		<th></th>
																		<th>AZ</th>
																		<th>Type</th>
																		<th>Running</th>
																		<th>Reserved</th>
																		<th>Delta</th>
																		<th>Up-Front</th>
																		<th>Savings/Loss</th>
																		<!--
																		<th>Hourly</th>
																		<th>Subtotal</th>

																		<th>On-Demand ?</th>

																		<th>Purchase</th>
																		-->
																</tr>
														</thead>
														<tfoot>
																<tr>
																		<th></th>
																		<th>AZ</th>
																		<th>Type</th>
																		<th>Running</th>
																		<th>Reserved</th>
																		<th>Delta</th>
																		<th>Up-Front</th>
																		<th>Savings/Loss</th>
																</tr>
														</tfoot>
												</table>
												<!-- end of sub-table -->
										</td>
								</tr>
						</tbody>
				</table>
		</div>
		<script type="text/javascript">
		// <![CDATA[
				$(document).ready(function() {
						$('table.datatable').each(function(idx) {
								var table = $(this).DataTable({
										"processing" : true,
										"serverSide" : false,
										"paging" : true,
										"pageLength" : 25,
										"autoWidth" : false,
										"ajax" : {
												"url" : "data",
												"type" : "POST",
												"data" : {
														"id" : $(this).attr("id")
												},
										},
										"columns" : [
												{
														'className' : 'details-control',
														'orderable' : false,
														'data' : null,
														'defaultContent' : ''
												},
												{ 'data' : 'zone' },
												{ 'data' : 'type' },
												{ 'data' : 'running' },
												{ 'data' : 'reserved' },
												{ 'data' : 'delta', 'className': 'delta-col' },
												{ 'data' : 'upfront', 'className' : 'upfront-col' },
												{ 'data' : 'savings', 'className' : 'savings-col' },
										],
								})
								// Add event listener for opening and closing details
								$('table.datatable#'+$(this).attr("id")+' tbody').on('click', 'td.details-control', function () {
										var tr = $(this).closest('tr');
										var row = table.row( tr );

										if ( row.child.isShown() ) {
												// This row is already open - close it
												row.child.hide();
												tr.removeClass('shown');
										} else {
												// Open this row
												row.child( format(row.data()) ).show();
												tr.addClass('shown');
										}
								} );
						})

						/* Formatting function for row details */
						function format ( d ) {
								console.log(d);
								// `d` is the original data object for the row
								var tbl = '<table class="details-table">'+
														'<thead>'+
														'<tr class="details-row">';
								if ( d.expiration.length > 0 ) {
										tbl += '<td class="details-row">RI Count</td>'+
														'<td class="details-row">RI Days Left</td>'+
														'<td class="details-row">RI End Date</td>'+
														'</tr>'+
														'</thead>'+
														'<tbody>';
										for (el in d.expiration) {
												tbl += '<tr class="details-row">'+
																'<td class="details-row">'+d.expiration[el].count+'</td>'+
																'<td class="details-row">'+d.expiration[el].days_left+'</td>'+
																'<td class="details-row">'+d.expiration[el].end_date+'</td>'+
																'</tr>';
										}
								} else {
										tbl += '<td class="details-row">No results to display</td>'+
												'</tr>'+
												'</thead>'+
												'<tbody>';
								}
								tbl += '</tbody>'+
												'</table>';
								console.log(tbl);
								return tbl;
						}

				})
		// ]]>
		</script>
  </body>
</html>
