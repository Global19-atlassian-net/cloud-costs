<!DOCTYPE html>
<html lang="${request.locale_name}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="pyramid web application">
    <meta name="author" content="Brett Lentz">
    <link rel="shortcut icon" href="${request.static_url('budget:static/pyramid-16x16.png')}">

    <title>OpenShift Statistics and Reporting</title>

    <link href="${request.static_url('budget:static/theme.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/reservation.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/jquery-ui-1.11.4/jquery-ui.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/jquery-ui-1.11.4/jquery-ui.theme.min.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/jquery-ui-1.11.4/theme.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/DataTables-1.10.11/media/css/jquery.dataTables.css')}" rel="stylesheet">
    <link href="${request.static_url('budget:static/DataTables-1.10.11/media/css/dataTables.jqueryui.css')}" rel="stylesheet">

    <script src="${request.static_url('budget:static/jquery-2.1.4.min.js')}"></script>
    <script src="${request.static_url('budget:static/jquery-ui-1.11.4/jquery-ui.min.js')}"></script>
    <script src="${request.static_url('budget:static/DataTables-1.10.11/media/js/jquery.dataTables.js')}"></script>
		<script src="${request.static_url('budget:static/DataTables-1.10.11/media/js/dataTables.jqueryui.js')}"></script>
  </head>

  <body>

		<div id="note">
				<p>For each listing, the delta will be:</p>
				<ul>
						<li>positive if there are unused reservations</li>
						<li>negative if there are on-demand instances in need of reservation</li>
				</ul>
		</div>
		<div id="csv" class="link">
				<a href="/reservation/csv">Click for CSV</a>
		</div>
		<div class="results_container" tal:repeat="account results" tal:attributes="id account">
				<table class="results_table" id="${account}">
						<thead class="account_header">
								<tr>
										<th id="${account}" class="account_name_header" tal:content="account"> Account Name</th>
								</tr>
						</thead>
						<tbody>
								<tr class="results_row">
										<td class="results_col">
												<!-- sub-table -->
												<table class="datatable" id="${account}">
														<thead>
																<tr>
																		<th></th>
																		<th>AZ</th>
																		<th>Type</th>
																		<th>Running</th>
																		<th>Reserved</th>
																		<th>Delta</th>
																		<th>Up-Front</th>
																		<th>Savings/Loss</th>
																		<!--
																		<th>Purchase</th>
																		-->
																</tr>
														</thead>
														<tfoot>
																<tr>
																		<th></th>
																		<th>AZ</th>
																		<th>Type</th>
																		<th>Running</th>
																		<th>Reserved</th>
																		<th>Delta</th>
																		<th>Up-Front</th>
																		<th>Savings/Loss</th>
																</tr>
														</tfoot>
												</table>
												<!-- end of sub-table -->
										</td>
								</tr>
						</tbody>
				</table>
		</div>
		<script type="text/javascript">
		// <![CDATA[
				$(document).ready(function() {
						$('table.datatable').each(function(idx) {
								var table = $(this).DataTable({
										"processing" : true,
										"serverSide" : false,
										"paging" : true,
										"pageLength" : 25,
										"autoWidth" : false,
										"ajax" : {
												"url" : "data",
												"type" : "POST",
												"data" : {
														"id" : $(this).attr("id")
												},
										},
										"columns" : [
												{
														'data' : null,
														'className' : 'details-control',
														'orderable' : false,
														'defaultContent' : ''
												},
												{ 'data' : 'zone', 'className' : 'availability-zone' },
												{ 'data' : 'type', 'className' : 'instance-type' },
												{
														'data' : 'running',
														'className' : 'running-count',
														'render' : function (data, type, full, meta) {
																return '<a href="#" class="running-count-link">'+data+'</a>';
														}
												},
												{ 'data' : 'reserved', 'className' : 'reservation-count' },
												{ 'data' : 'delta', 'className' : 'delta-col' },
												{ 'data' : 'upfront', 'className' : 'upfront-col' },
												{ 'data' : 'savings', 'className' : 'savings-col' },
										],
										"order": [[1, 'desc']],
										"rowCallback" : function (row, data, index) {
												var className = "";
												if (parseInt(data.delta) > 0) {
														className = 'positive';
												} else if (parseInt(data.delta) < 0) {
														className = 'negative';
												}
												$('td:eq(5)', row).addClass(className);

												var savings = Number(data.savings.replace(/[^0-9\.-]+/g,""));
												if (savings > 0) {
														className = 'positive';
												} else if (savings < 0) {
														className = 'negative';
												}
												$('td:eq(7)', row).addClass(className);

												return row;
										},
										"footerCallback" : function (row, data, start, end, display) {
												var api = this.api(), data;

												cols = [3,4,5,6]
												for (n in cols) {
														// Total over all pages
														total = api
														.column( cols[n] )
														.data()
														.reduce( function (a, b) {
																a = String(a).replace(/[^0-9\.-]+/g,"")
																b = String(b).replace(/[^0-9\.-]+/g,"")
																return Number(a) + Number(b);
														}, 0 );

														// because the table renders itself a couple times,
														// to preserve the label, we need to strip out
														// previous iterations of the total.
														var label = $(api.column(cols[n]).footer()).html().replace(/\(-?\$?\d+,?\d*\.?\d*\)/,'');
														// Update footer
														if (cols[n] == 6) {
																$(api.column(cols[n]).footer()).html(
																		label + ' ('+
																		total.toLocaleString(
																				'en-US', {
																						style : 'currency',
																						currency : 'USD',
																						currencyDisplay : 'symbol',
																						minimumFractionDigits : 2
																		})+
																		')'
																);
														} else {
																$( api.column( cols[n] ).footer() ).html(
																		label+' ('+total +')'
																);
														}
												}
										},
								}) // end DataTable

								// Add event listener for opening and closing details
								$('table.datatable#'+$(this).attr("id")+' tbody').on('click', 'td.details-control', function () {
										var tr = $(this).closest('tr');
										var row = table.row( tr );

										if ( row.child.isShown() ) {
												// This row is already open - close it
												row.child.hide();
												tr.removeClass('shown');
										} else {
												// Open this row
												row.child( format_details(row.data()) ).show();
												tr.addClass('shown');
										}
								} );

								// Instances List Dialog
								var dialog = $("#dialog").dialog({
												autoOpen: false,
												height: 'auto',
												width: 'auto',
												modal: false,
												resizable: true,
												closeOnEscape: true,
												closeText: null,
								});

								// Add event listener for displaying instances list dialog
								$('table.datatable#'+$(this).attr("id")+' tbody').on('click', 'a.running-count-link', function () {
										var row = $(this).closest("tr");
										var account = $(this).closest("table.results_table").attr('id');
										var az = row.children("td.availability-zone").text();
										var size = row.children("td.instance-type").text();

										var tbl = '<table class="instances-table"></table>';
										$("#dialog").html(tbl)
												.children('table.instances-table')
												.DataTable({
														"processing" : true,
														"serverSide" : false,
														"paging" : true,
														"pageLength" : 10,
														"autoWidth" : false,
														"ajax" : {
																"url": '/reservation/instances',
																"type" : "POST",
																"data": {
																		'availability-zone' : az,
																		'instance-type' :	size,
																		'account' : account
																},
														},
														"columns" : [
																{
																		'data' : 'id',
																		'className' : 'instances-id-col',
																		'title' : 'ID',
																},
																{
																		'data' : 'name',
																		'className' : 'instances-name-col',
																		'title' : 'Name',
																},
																{
																		'data' : 'env',
																		'className' : 'instances-env-col',
																		'title' : 'Environment',
																},
														]
												});
										$("#dialog")
												.dialog({ title: size+' in '+az })
												.dialog("open");
								});
						}); // end datatable.each()

						/* Formatting function for row details */
						function format_details (d) {
								// `d` is the original data object for the row
								var tbl = '<table class="details-table">'+
														'<thead>'+
														'<tr class="details-row">';
								if (d.expiration.length > 0) {
										tbl += '<td class="details-col">RI Count</td>'+
														'<td class="details-col">RI Days Left</td>'+
														'<td class="details-col">RI End Date</td>'+
														'</tr>'+
														'</thead>'+
														'<tbody>';
										for (el in d.expiration.sort(
																		function(a,b) {
																				return Number(a.days_left) - Number(b.days_left);
																		})
										) {
												tbl += '<tr class="details-row">'+
																'<td class="details-col">'+d.expiration[el].count+'</td>'+
																'<td class="details-col">'+d.expiration[el].days_left+'</td>'+
																'<td class="details-col">'+d.expiration[el].end_date+'</td>'+
																'</tr>';
										}
								} else {
										tbl += '<td class="details-col">No reservation details to display</td>'+
												'</tr>'+
												'</thead>'+
												'<tbody>';
								}
								tbl += '</tbody>'+
												'</table>';
								return tbl;
						}
				})
		// ]]>
		</script>
		<div id="dialog"></div>
  </body>
</html>
